{% extends '::App/base.html.twig' %}

{% block title %}All the scheduled Jobs{% endblock %}

{% block body %}
    <h1>Scheduled Jobs in the Queue</h1>
    <p><small><a href="{{ url('queues_test_random') }}">Generate 100 random jobs.</a></small> | <small><a href="{{ url('queues_test_failed') }}">Generate failing jobs.</a> - <a href="{{ path('queues_jobs', {'status': 'new'}) }}">Show only <span class="label label-default">NEW</span></a></small></p>

    {% if jobPager.haveToPaginate %}
        {{ jobPagerView.render(jobPager, jobPagerGenerator)|raw }}
    {% endif %}

    <table class="table">
        <thead>
            <th>ID</th>
            <th>Command & Timing</th>
            <th>Priority</th>
            <th>Queue</th>
            <th width="10%">Status</th>
            <th width="30%">Dependencies</th>
            <th>Exit code</th>
            <th>Retry strategy</th>
        </thead>
    {% for job in jobPager %}
        {% set status = '' %}
        {% if 'running' == job.status %}
            {% set status = 'active' %}
        {% endif %}
        {% if 'retried' == job.status %}
            {% set status = 'warning' %}
        {% endif %}
        {% if 'failed' == job.status or 'retry_failed' == job.status %}
            {% set status = 'danger' %}
        {% endif %}
        {% if 'succeeded' == job.status or 'retry_succeeded' == job.status %}
            {% set status = 'success' %}
        {% endif %}
        {% if 'cancelled' == job.status %}
            {% set status = 'danger' %}
        {% endif %}
        {% if 'pending' == job.status or 'running' == job.status %}
            {% set status = 'info' %}
        {% endif %}
        <tr{% if '' != status %} class="{{ status }}"{% endif %}>
            <td id="{{ job.id }}"><a href="{{ path('queues_job', {id: job.id}) }}">{{ job.id }}</a></td>
            <td>
                <p>
                    <code style="width:300px; overflow:hidden; white-space:nowrap;">{{ job.command }}
                    {% if job.arguments %}
                        <span class="text-muted">{{ job.arguments|join(' ') }}</span>
                    {% endif %}
                    </code>
                </p>
                <p>
                    <b>Created at</b>: {% if job.createdAt %}{{ job.createdAt|localizeddate("none", "none", locale, null, "cccc, d MMMM Y', ' hh:mm aaa") }}{% endif %}<br />
                    <b>Execute after</b>: {% if job.executeAfterTime %}{{ job.executeAfterTime|localizeddate("none", "none", locale, null, "cccc, d MMMM Y', ' hh:mm aaa") }}{% endif %}<br />
                    <b>Started at</b>: {% if job.startedAt %}{{ job.startedAt|localizeddate("none", "none", locale, null, "cccc, d MMMM Y', ' hh:mm aaa") }}{% endif %}<br />
                    <b>Closed At</b>: {% if job.closedAt %}{{ job.closedAt|localizeddate("none", "none", locale, null, "cccc, d MMMM Y', ' hh:mm aaa") }}{% endif %}<br />
                </p>
            </td>
            <td><code>{{ job.priority }}</code></td>
            <td><code>{{ job.queue }}</code></td>
            <td>
                {% if 'new' == job.status %}
                    {% set status = 'default' %}
                {% endif %}
                <span class="label label-{{ status }}">{{ job.status }}</span>
                {% if job.isRetry %}
                    <p><small class="text-muted">Is retry of <a href="{{ path('queues_job', {'id': job.retryOf.id}) }}">#{{ job.retryOf.id }}</a></small></p>
                {% endif %}
                {% if job.isRetried %}
                    {% set status = '' %}
                    {% if 'running' == job.retriedBy.status %}
                        {% set status = 'active' %}
                    {% endif %}
                    {% if 'retried' == job.retriedBy.status %}
                        {% set status = 'warning' %}
                    {% endif %}
                    {% if 'failed' == job.retriedBy.status or 'retry_failed' == job.retriedBy.status %}
                        {% set status = 'danger' %}
                    {% endif %}
                    {% if 'succeeded' == job.retriedBy.status or 'retry_succeeded' == job.retriedBy.status %}
                        {% set status = 'success' %}
                    {% endif %}
                    {% if 'cancelled' == job.retriedBy.status %}
                        {% set status = 'danger' %}
                    {% endif %}
                    {% if 'pending' == job.retriedBy.status or 'running' == job.retriedBy.status %}
                        {% set status = 'info' %}
                    {% endif %}
                    {% if 'new' == job.retriedBy.status %}
                        {% set status = 'default' %}
                    {% endif %}
                    <p><small class="text-muted">Retried by <br /><a href="{{ path('queues_job', {'id': job.retriedBy.id}) }}">#{{ job.retriedBy.id }}</a> <span class="label label-{{ status }}">{{ job.retriedBy.status }}</span></small></p>
                    {% if 0 < job.retryingJobs.count %}
                        <small class="text-muted">All retrying Jobs:</small>
                        {% set retryingJobs = {} %}
                        {% for retryingJob in job.retryingJobs %}
                            {% set status = '' %}
                            {% if 'running' == retryingJob.status %}
                                {% set status = 'active' %}
                            {% endif %}
                            {% if 'retried' == retryingJob.status %}
                                {% set status = 'warning' %}
                            {% endif %}
                            {% if 'failed' == retryingJob.status or 'retry_failed' == retryingJob.status %}
                                {% set status = 'danger' %}
                            {% endif %}
                            {% if 'succeeded' == retryingJob.status or 'retry_succeeded' == retryingJob.status %}
                                {% set status = 'success' %}
                            {% endif %}
                            {% if 'cancelled' == retryingJob.status %}
                                {% set status = 'danger' %}
                            {% endif %}
                            {% if 'pending' == retryingJob.status or 'running' == retryingJob.status %}
                                {% set status = 'info' %}
                            {% endif %}
                            {% if 'new' == retryingJob.status %}
                                {% set status = 'default' %}
                            {% endif %}
                            {% set linkedretryingJob = '<a href="' ~ path('queues_job', {'id': retryingJob.id}) ~ '">#' ~ retryingJob.id ~ '</a> <span class="label label-' ~ status ~ '">' ~ retryingJob.status ~ '</span>' %}
                            {% set retryingJobs = retryingJobs|merge({ ('_' ~ retryingJob.id ~ '-'): linkedretryingJob}) %}
                        {% endfor %}
                        <p><small class="text-muted">{{ retryingJobs|join(' - ')|raw }}</small></p>
                    {% endif %}
                {% endif %}
                {% if job.firstRetriedJob %}
                    {% set status = '' %}
                    {% if 'running' == job.firstRetriedJob.status %}
                        {% set status = 'active' %}
                    {% endif %}
                    {% if 'retried' == job.firstRetriedJob.status %}
                        {% set status = 'warning' %}
                    {% endif %}
                    {% if 'failed' == job.firstRetriedJob.status or 'retry_failed' == job.firstRetriedJob.status %}
                        {% set status = 'danger' %}
                    {% endif %}
                    {% if 'succeeded' == job.firstRetriedJob.status or 'retry_succeeded' == job.firstRetriedJob.status %}
                        {% set status = 'success' %}
                    {% endif %}
                    {% if 'cancelled' == job.firstRetriedJob.status %}
                        {% set status = 'danger' %}
                    {% endif %}
                    {% if 'pending' == job.firstRetriedJob.status or 'running' == job.firstRetriedJob.status %}
                        {% set status = 'info' %}
                    {% endif %}
                    <p><small class="text-muted">First retried job:<br /><a href="{{ path('queues_job', {'id': job.firstRetriedJob.id}) }}">#{{ job.firstRetriedJob.id }} <span class="label label-{{ status }}">{{ job.firstRetriedJob.status }}</span></a></small></p>
                {% endif %}
                {% if 'cancelled' == job.status %}
                    <p><small class="text-muted">{{ job.debug.cancellation_reason }}</small></p>
                    <p><small class="text-muted">Cancelled by <a href="{{ path('queues_job', {'id': job.cancelledBy}) }}">#{{ job.cancelledBy }}</a></small></p>
                {% endif %}
            </td>
            <td>
                {% if false == job.hasParentDependencies %}
                {% if false == job.isRetry %}No parent Jobs{% endif %}
                {% else %}
                    <p>Parent Jobs:</p>
                    {% set parentJobs = {} %}
                    {% for parentJob in job.parentDependencies %}
                        {% set status = '' %}
                        {% if 'running' == parentJob.status %}
                            {% set status = 'active' %}
                        {% endif %}
                        {% if 'retried' == parentJob.status %}
                            {% set status = 'warning' %}
                        {% endif %}
                        {% if 'failed' == parentJob.status or 'retry_failed' == parentJob.status %}
                            {% set status = 'danger' %}
                        {% endif %}
                        {% if 'succeeded' == parentJob.status or 'retry_succeeded' == parentJob.status %}
                            {% set status = 'success' %}
                        {% endif %}
                        {% if 'cancelled' == parentJob.status %}
                            {% set status = 'danger' %}
                        {% endif %}
                        {% if 'pending' == parentJob.status or 'running' == parentJob.status %}
                            {% set status = 'info' %}
                        {% endif %}
                        {% if 'new' == parentJob.status %}
                            {% set status = 'default' %}
                        {% endif %}
                        {% set linkedParentJob = '<a href="' ~ path('queues_job', {'id': parentJob.id}) ~ '">#' ~ parentJob.id ~ '</a> <span class="label label-' ~ status ~ '">' ~ parentJob.status ~ '</span>' %}
                        {% set parentJobs = parentJobs|merge({ ('_' ~ parentJob.id ~ '-'): linkedParentJob}) %}
                    {% endfor %}
                    <p>{{ parentJobs|join(' - ')|raw }}</p>
                {% endif %}
                {% if false == job.isRetry %}<hr />{% endif %}
                {% if false == job.hasChildDependencies %}
                    No child Jobs
                {% else %}
                    <p>Child Jobs:</p>
                    {% set childJobs = {} %}
                    {% for childJob in job.childDependencies %}
                        {% set status = '' %}
                        {% if 'running' == childJob.status %}
                            {% set status = 'active' %}
                        {% endif %}
                        {% if 'retried' == childJob.status %}
                            {% set status = 'warning' %}
                        {% endif %}
                        {% if 'failed' == childJob.status or 'retry_failed' == childJob.status %}
                            {% set status = 'danger' %}
                        {% endif %}
                        {% if 'succeeded' == childJob.status or 'retry_succeeded' == childJob.status %}
                            {% set status = 'success' %}
                        {% endif %}
                        {% if 'cancelled' == childJob.status %}
                            {% set status = 'danger' %}
                        {% endif %}
                        {% if 'pending' == childJob.status or 'running' == childJob.status %}
                            {% set status = 'info' %}
                        {% endif %}
                        {% if 'new' == childJob.status %}
                            {% set status = 'default' %}
                        {% endif %}
                        {% set linkedChildJob = '<a href="' ~ path('queues_job', {'id': childJob.id}) ~ '">#' ~ childJob.id ~ '</a> <span class="label label-' ~ status ~ '">' ~ childJob.status ~ '</span>' %}
                        {% set childJobs = childJobs|merge({ ('_' ~ childJob.id ~ '-'): linkedChildJob}) %}
                    {% endfor %}
                    <p>{{ childJobs|join(' - ')|raw }}</p>
                {% endif %}
            </td>
            <td>{{ job.exitCode }}</td>
            <td>
                {% if job.retryStrategy.canRetry %}{{ job.retryStrategy.retryOn|localizeddate("none", "none", locale, null, "cccc, d MMMM Y', ' hh:mm aaa") }}{% endif %}
                <small class="text-muted">{{ job.retryStrategy.strategyName }}</small>
                <p>
                    <small>
                        Current attempt: {{ job.retryStrategy.attempts }}, Max attempts: {{ job.retryStrategy.maxAttempts }},
                        Increment by: {{ job.retryStrategy.incrementBy }} {{ job.retryStrategy.timeUnit }},
                        {% if 'exponential' == job.retryStrategy.strategyName %}Exponential base: {{ job.retryStrategy.exponentialBase }}, {% endif %}
                    </small>
                </p>
            </td>
        </tr>
    {% endfor %}
    </table>

    {% if jobPager.haveToPaginate %}
        {{ jobPagerView.render(jobPager, jobPagerGenerator)|raw }}
    {% endif %}
{% endblock %}
